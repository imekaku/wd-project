<source>
  type forward
  port 24224
  bind 0.0.0.0
</source>

# add system time on log-file name
<match docker.**>
  type record_reformer
  tag reformed01.${tag}
  local_time01 ${time.strftime('%Y-%m-%d-%H')}
</match>

# add system time on log-file path
<match reformed01.**>
  type record_reformer
  tag reformed02.${tag}
  local_time02 ${time.strftime('%Y-%m-%d')}
</match>

# add regexp for service
{{range $i, $v := .Services}}
<match reformed02.docker.{{$i}}.**>
  type grep
  regexp1 log {{$v}}
  add_tag_prefix regexp
</match>
{{end}}

# add tag for services that do not have regexp
<match reformed02.docker.**>
  type grep
  add_tag_prefix regexp
</match>

# divive system out and system err
<match regexp.**>
  type rewrite_tag_filter
  rewriterule1 source stdout system_out.${tag}
  rewriterule2 source stderr system_err.${tag}
</match>

<match system_err.**>
  type copy
  <store>
    type rewrite_tag_filter
    rewriterule1 local_time01 ^(.+)$ local.$1.${tag}
    rewriterule2 local_time02 ^(.+)$ local.$1.${tag}    
  </store>
  <store>
    type rewrite_tag_filter
    rewriterule1 local_time01 ^(.+)$ $1.${tag}
    rewriterule2 local_time02 ^(.+)$ $1.${tag}    
  </store>
</match>

<match system_out.**>
  type copy
  <store>
    type rewrite_tag_filter
    rewriterule1 local_time01 ^(.+)$ local.$1.${tag}
    rewriterule2 local_time02 ^(.+)$ local.$1.${tag}    
  </store>
  <store>
    type rewrite_tag_filter
    rewriterule1 local_time01 ^(.+)$ $1.${tag}
    rewriterule2 local_time02 ^(.+)$ $1.${tag}    
  </store>
</match>

# local[0].2016-11-10[1].2016-11-10-15[2].system_err[3].regexp[4].reformed[5].docker[6].db[7].temp01[8].1[9].bjswdrsl40qsdhjiv2pw0gc0z
<match local.**>
  type forest
  subtype file
  <template>
    output_tag false
    output_time false
    message_key log
    format single_value
    time_slice_format %Y%m%dT%H
    path /home/work/fluentd-log/${tag_parts[8]}/${tag_parts[1]}/${tag_parts[9]}/${tag_parts[2]}.${tag_parts[7]}.${tag_parts[3]}.docker_log
    buffer_chunk_limit 256m
    buffer_queue_limit 128
    flush_interval 3m
    disable_retry_limit false
    retry_limit 17
    retry_wait 1s
  </template>
</match>

<match **>
  type forward
  {{range $i, $v := .Servers}}
  <server>
    host {{$v}}
    port 24224
    weight 30
  </server>
  {{end}}
  flush_interval 5s
</match>
